<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Playora</title>
    <link rel="stylesheet" href="fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/templatemo-style.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .admin-nav {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .admin-nav .nav-link {
            color: #495057;
            font-weight: 500;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            margin: 0 0.25rem;
        }
        .admin-nav .nav-link.active {
            background: #007bff;
            color: white;
        }
        .admin-nav .nav-link:hover {
            background: #e9ecef;
            color: #007bff;
        }
        .admin-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .admin-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .btn-admin {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .table th {
            border-top: none;
            background: #f8f9fa;
            font-weight: 600;
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
        }
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0"><i class="fas fa-cogs"></i> Admin Panel</h1>
                    <p class="mb-0">Kelola Aplikasi dan Game Playora</p>
                </div>
                <div class="col-md-6 text-md-right">
                    <a href="index.html" class="btn btn-light btn-admin">
                        <i class="fas fa-home"></i> Kembali ke Website
                    </a>
                    <button class="btn btn-outline-light btn-admin ml-2" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Admin Navigation -->
        <div class="admin-nav">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item">
                    <a class="nav-link active" href="#dashboard" data-toggle="pill">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#applications" data-toggle="pill">
                        <i class="fas fa-list"></i> Daftar Aplikasi
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#add-app" data-toggle="pill">
                        <i class="fas fa-plus"></i> Tambah Aplikasi
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#analytics" data-toggle="pill">
                        <i class="fas fa-chart-line"></i> Analytics
                    </a>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h3 id="totalApps">0</h3>
                            <p class="mb-0"><i class="fas fa-mobile-alt"></i> Total Aplikasi</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h3 id="totalGames">0</h3>
                            <p class="mb-0"><i class="fas fa-gamepad"></i> Total Game</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h3 id="totalAll">0</h3>
                            <p class="mb-0"><i class="fas fa-chart-bar"></i> Total Semua</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Statistik Terbaru</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Aplikasi Terbaru</h6>
                                <div id="recentApps">Loading...</div>
                            </div>
                            <div class="col-md-6">
                                <h6>Game Terbaru</h6>
                                <div id="recentGames">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Applications List Tab -->
            <div class="tab-pane fade" id="applications">
                <div class="admin-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Daftar Aplikasi & Game</h5>
                        <div>
                            <select class="form-control form-control-sm" id="categoryFilter" style="width: auto; display: inline-block;">
                                <option value="">Semua Kategori</option>
                                <option value="app">Aplikasi</option>
                                <option value="game">Game</option>
                            </select>
                            <button class="btn btn-sm btn-light ml-2" onclick="refreshApplicationsList()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner" id="appsLoadingSpinner">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Memuat data...</p>
                        </div>
                        <div id="applicationsTable"></div>
                        <div id="pagination" class="d-flex justify-content-center mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Add Application Tab -->
            <div class="tab-pane fade" id="add-app">
                <div class="admin-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plus"></i> Tambah Aplikasi/Game Baru</h5>
                    </div>
                    <div class="card-body">
                        <form id="addAppForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appTitle">Judul *</label>
                                        <input type="text" class="form-control" id="appTitle" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appCategory">Kategori *</label>
                                        <select class="form-control" id="appCategory" required>
                                            <option value="">Pilih Kategori</option>
                                            <option value="app">Aplikasi</option>
                                            <option value="game">Game</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="appDescription">Deskripsi *</label>
                                <textarea class="form-control" id="appDescription" rows="3" required></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="appPrice">Harga *</label>
                                        <input type="number" class="form-control" id="appPrice" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="appRating">Rating (0-5)</label>
                                        <input type="number" class="form-control" id="appRating" min="0" max="5" step="0.1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="appDeveloper">Developer</label>
                                        <input type="text" class="form-control" id="appDeveloper">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appImageUrl">URL Gambar Utama</label>
                                        <input type="url" class="form-control" id="appImageUrl" placeholder="URL gambar untuk tampilan daftar">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appDetailImageUrl">URL Gambar Detail</label>
                                        <input type="url" class="form-control" id="appDetailImageUrl" placeholder="URL gambar untuk halaman detail">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appDemoUrl">URL Demo</label>
                                        <input type="url" class="form-control" id="appDemoUrl">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appDownloadUrl">URL Download</label>
                                        <input type="url" class="form-control" id="appDownloadUrl">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="appDownloadUrl">URL Download</label>
                                        <input type="url" class="form-control" id="appDownloadUrl">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="appVersion">Versi</label>
                                        <input type="text" class="form-control" id="appVersion" placeholder="1.0.0">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="appSize">Ukuran</label>
                                        <input type="text" class="form-control" id="appSize" placeholder="10 MB">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="appFeatures">Fitur (pisahkan dengan koma)</label>
                                <textarea class="form-control" id="appFeatures" rows="2" placeholder="Fitur 1, Fitur 2, Fitur 3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="appTags">Tags (pisahkan dengan koma)</label>
                                <input type="text" class="form-control" id="appTags" placeholder="tag1, tag2, tag3">
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-admin">
                                    <i class="fas fa-save"></i> Simpan Aplikasi
                                </button>
                                <button type="reset" class="btn btn-secondary btn-admin ml-2">
                                    <i class="fas fa-undo"></i> Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analytics">
                <div class="admin-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Analytics Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <!-- Stats Overview -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 id="totalVisitors">0</h3>
                                    <p>Total Visitors</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 id="todayVisitors">0</h3>
                                    <p>Today's Visitors</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 id="totalPageViews">0</h3>
                                    <p>Page Views</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card text-center">
                                    <h3 id="uniqueVisitors">0</h3>
                                    <p>Unique Visitors</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Section -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Visitor Trends (Last 7 Days)</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="visitorChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Device Types</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="deviceChart" width="200" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Pages -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Top Pages</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="topPages">
                                            <p class="text-muted">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Recent Visitors</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentVisitors">
                                            <p class="text-muted">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics Data Table -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Visitor Logs</h6>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="refreshAnalytics()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="exportAnalytics()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Filter Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="dateFilter" class="form-label">Filter by Date:</label>
                                        <select class="form-select form-select-sm" id="dateFilter" onchange="applyFilters()">
                                            <option value="all">All Time</option>
                                            <option value="today">Today</option>
                                            <option value="yesterday">Yesterday</option>
                                            <option value="week">Last 7 Days</option>
                                            <option value="month">Last 30 Days</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="pageFilter" class="form-label">Filter by Page:</label>
                                        <select class="form-select form-select-sm" id="pageFilter" onchange="applyFilters()">
                                            <option value="all">All Pages</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="deviceFilter" class="form-label">Filter by Device:</label>
                                        <select class="form-select form-select-sm" id="deviceFilter" onchange="applyFilters()">
                                            <option value="all">All Devices</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="searchFilter" class="form-label">Search:</label>
                                        <input type="text" class="form-control form-control-sm" id="searchFilter" placeholder="Search IP, browser..." oninput="applyFilters()">
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped" id="analyticsTable">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Page</th>
                                                <th>IP Address</th>
                                                <th>Device</th>
                                                <th>Browser</th>
                                                <th>Referrer</th>
                                            </tr>
                                        </thead>
                                        <tbody id="analyticsTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Loading analytics data...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Aplikasi</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editAppForm">
                        <input type="hidden" id="editAppId">
                        <!-- Form fields sama seperti add form -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editAppTitle">Judul *</label>
                                    <input type="text" class="form-control" id="editAppTitle" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editAppCategory">Kategori *</label>
                                    <select class="form-control" id="editAppCategory" required>
                                        <option value="app">Aplikasi</option>
                                        <option value="game">Game</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editAppDescription">Deskripsi *</label>
                            <textarea class="form-control" id="editAppDescription" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editAppPrice">Harga *</label>
                                    <input type="number" class="form-control" id="editAppPrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editAppRating">Rating (0-5)</label>
                                    <input type="number" class="form-control" id="editAppRating" min="0" max="5" step="0.1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="editAppDeveloper">Developer</label>
                                    <input type="text" class="form-control" id="editAppDeveloper">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editAppImageUrl">URL Gambar Utama</label>
                                    <input type="url" class="form-control" id="editAppImageUrl" placeholder="URL gambar untuk tampilan daftar">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editAppDetailImageUrl">URL Gambar Detail</label>
                                    <input type="url" class="form-control" id="editAppDetailImageUrl" placeholder="URL gambar untuk halaman detail">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editAppDemoUrl">URL Demo</label>
                                    <input type="url" class="form-control" id="editAppDemoUrl">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="editAppDownloadUrl">URL Download</label>
                                    <input type="url" class="form-control" id="editAppDownloadUrl">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditApplication()">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel"><i class="fas fa-trash"></i> Konfirmasi Hapus</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menghapus aplikasi <strong id="deleteAppName"></strong>?</p>
                    <p class="text-danger"><small>Tindakan ini tidak dapat dibatalkan.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/database.js"></script>
    
    <script>
        // Global variables
        let currentPage = 1
        let currentCategory = ''
        
        // Check authentication before initializing
        document.addEventListener('DOMContentLoaded', function() {
            if (!isLoggedIn()) {
                window.location.href = 'login.html'
                return
            }
            initializeAdminPanel()
        })
        
        // Check if user is logged in
        function isLoggedIn() {
            const sessionLogin = sessionStorage.getItem('adminLogin')
            const localLogin = localStorage.getItem('adminLogin')
            
            if (sessionLogin || localLogin) {
                try {
                    const loginData = JSON.parse(sessionLogin || localLogin)
                    const loginTime = new Date(loginData.loginTime)
                    const now = new Date()
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60)
                    
                    // Session expires after 24 hours
                    if (hoursDiff < 24) {
                        return true
                    } else {
                        // Clear expired session
                        sessionStorage.removeItem('adminLogin')
                        localStorage.removeItem('adminLogin')
                        return false
                    }
                } catch (error) {
                    return false
                }
            }
            
            return false
        }
        
        // Initialize admin panel
        function initializeAdminPanel() {
            loadDashboardStats()
            loadApplicationsList()
            
            // Setup form handlers
            setupFormHandlers()
            
            // Setup category filter
            document.getElementById('categoryFilter').addEventListener('change', function() {
                currentCategory = this.value
                currentPage = 1
                loadApplicationsList()
            })
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const [appsResult, gamesResult] = await Promise.all([
                    PlayoraDB.getApplications('app'),
                    PlayoraDB.getApplications('game')
                ])
                
                const totalApps = appsResult.length
                const totalGames = gamesResult.length
                const totalAll = totalApps + totalGames
                
                document.getElementById('totalApps').textContent = totalApps
                document.getElementById('totalGames').textContent = totalGames
                document.getElementById('totalAll').textContent = totalAll
                
                // Load recent items
                loadRecentItems(appsResult.slice(0, 3), gamesResult.slice(0, 3))
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error)
            }
        }
        
        // Load recent items
        function loadRecentItems(recentApps, recentGames) {
            const appsContainer = document.getElementById('recentApps')
            const gamesContainer = document.getElementById('recentGames')
            
            if (recentApps.length === 0) {
                appsContainer.innerHTML = '<p class="text-muted">Belum ada aplikasi</p>'
            } else {
                appsContainer.innerHTML = recentApps.map(app => `
                    <div class="d-flex align-items-center mb-2">
                        <img src="${app.image_url || 'img/img-01.jpg'}" alt="${app.title}" 
                             style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">
                        <div class="ml-2">
                            <strong>${app.title}</strong><br>
                            <small class="text-muted">${formatDate(app.created_at)}</small>
                        </div>
                    </div>
                `).join('')
            }
            
            if (recentGames.length === 0) {
                gamesContainer.innerHTML = '<p class="text-muted">Belum ada game</p>'
            } else {
                gamesContainer.innerHTML = recentGames.map(game => `
                    <div class="d-flex align-items-center mb-2">
                        <img src="${game.image_url || 'img/img-01.jpg'}" alt="${game.title}" 
                             style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">
                        <div class="ml-2">
                            <strong>${game.title}</strong><br>
                            <small class="text-muted">${formatDate(game.created_at)}</small>
                        </div>
                    </div>
                `).join('')
            }
        }
        
        // Load applications list
        async function loadApplicationsList() {
            const spinner = document.getElementById('appsLoadingSpinner')
            const container = document.getElementById('applicationsTable')
            
            spinner.style.display = 'block'
            
            try {
                const result = await PlayoraDB.getApplicationsForAdmin(currentPage, 10, currentCategory || null)
                
                if (result.success) {
                    PlayoraDB.renderAdminTable(result.data, container)
                    renderPagination(result.pagination)
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`
                }
            } catch (error) {
                console.error('Error loading applications:', error)
                container.innerHTML = `<div class="alert alert-danger">Error loading data</div>`
            } finally {
                spinner.style.display = 'none'
            }
        }
        
        // Render pagination
        function renderPagination(pagination) {
            const container = document.getElementById('pagination')
            
            if (pagination.totalPages <= 1) {
                container.innerHTML = ''
                return
            }
            
            let paginationHTML = '<nav><ul class="pagination">'
            
            // Previous button
            if (pagination.page > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">Previous</a></li>`
            }
            
            // Page numbers
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === pagination.page) {
                    paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`
                } else {
                    paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`
                }
            }
            
            // Next button
            if (pagination.page < pagination.totalPages) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">Next</a></li>`
            }
            
            paginationHTML += '</ul></nav>'
            container.innerHTML = paginationHTML
        }
        
        // Change page
        function changePage(page) {
            currentPage = page
            loadApplicationsList()
        }
        
        // Refresh applications list
        function refreshApplicationsList() {
            loadApplicationsList()
            loadDashboardStats()
        }
        
        // Setup form handlers
        function setupFormHandlers() {
            document.getElementById('addAppForm').addEventListener('submit', async function(e) {
                e.preventDefault()
                await addNewApplication()
            })
        }
        
        // Add new application
        async function addNewApplication() {
            const formData = {
                title: document.getElementById('appTitle').value,
                description: document.getElementById('appDescription').value,
                category: document.getElementById('appCategory').value,
                price: parseFloat(document.getElementById('appPrice').value),
                rating: parseFloat(document.getElementById('appRating').value) || 0,
                developer: document.getElementById('appDeveloper').value,
                image_url: document.getElementById('appImageUrl').value,
                detail_image_url: document.getElementById('appDetailImageUrl').value,
                demo_url: document.getElementById('appDemoUrl').value,
                download_url: document.getElementById('appDownloadUrl').value,
                version: document.getElementById('appVersion').value || '1.0.0',
                size: document.getElementById('appSize').value,
                features: document.getElementById('appFeatures').value.split(',').map(f => f.trim()).filter(f => f),
                tags: document.getElementById('appTags').value.split(',').map(t => t.trim()).filter(t => t)
            }
            
            try {
                const result = await PlayoraDB.addApplication(formData)
                
                if (result.success) {
                    alert('Aplikasi berhasil ditambahkan!')
                    document.getElementById('addAppForm').reset()
                    loadApplicationsList()
                    loadDashboardStats()
                    
                    // Switch to applications tab
                    $('a[href="#applications"]').tab('show')
                } else {
                    alert('Error: ' + result.error)
                }
            } catch (error) {
                console.error('Error adding application:', error)
                alert('Terjadi kesalahan saat menambah aplikasi')
            }
        }
        
        // Edit application
        async function editApplication(id) {
            try {
                const app = await PlayoraDB.getApplicationById(id)
                
                if (app) {
                    // Fill edit form
                    document.getElementById('editAppId').value = app.id
                    document.getElementById('editAppTitle').value = app.title
                    document.getElementById('editAppCategory').value = app.category
                    document.getElementById('editAppDescription').value = app.description
                    document.getElementById('editAppPrice').value = app.price
                    document.getElementById('editAppRating').value = app.rating
                    document.getElementById('editAppDeveloper').value = app.developer || ''
                    document.getElementById('editAppImageUrl').value = app.image_url || ''
                    document.getElementById('editAppDetailImageUrl').value = app.detail_image_url || ''
                    document.getElementById('editAppDemoUrl').value = app.demo_url || ''
                    document.getElementById('editAppDownloadUrl').value = app.download_url || ''
                    
                    // Show modal
                    $('#editModal').modal('show')
                }
            } catch (error) {
                console.error('Error loading application for edit:', error)
                alert('Error loading application data')
            }
        }
        
        // Save edit application
        async function saveEditApplication() {
            const id = document.getElementById('editAppId').value
            const formData = {
                title: document.getElementById('editAppTitle').value,
                description: document.getElementById('editAppDescription').value,
                category: document.getElementById('editAppCategory').value,
                price: parseFloat(document.getElementById('editAppPrice').value),
                rating: parseFloat(document.getElementById('editAppRating').value) || 0,
                developer: document.getElementById('editAppDeveloper').value,
                image_url: document.getElementById('editAppImageUrl').value,
                detail_image_url: document.getElementById('editAppDetailImageUrl').value,
                demo_url: document.getElementById('editAppDemoUrl').value,
                download_url: document.getElementById('editAppDownloadUrl').value
            }
            
            try {
                const result = await PlayoraDB.updateApplication(id, formData)
                
                if (result.success) {
                    alert('Aplikasi berhasil diupdate!')
                    $('#editModal').modal('hide')
                    loadApplicationsList()
                    loadDashboardStats()
                } else {
                    alert('Error: ' + result.error)
                }
            } catch (error) {
                console.error('Error updating application:', error)
                alert('Terjadi kesalahan saat mengupdate aplikasi')
            }
        }
        
        // Confirm delete application
        function confirmDeleteApplication(id, title) {
            document.getElementById('deleteAppName').textContent = title
            document.getElementById('confirmDeleteBtn').onclick = () => deleteApplication(id)
            $('#deleteModal').modal('show')
        }
        
        // Delete application
        async function deleteApplication(id) {
            try {
                console.log('Starting delete process for ID:', id)
                const result = await PlayoraDB.deleteApplication(id)
                
                if (result.success) {
                    console.log('Delete successful:', result)
                    alert('Aplikasi berhasil dihapus!')
                    $('#deleteModal').modal('hide')
                    
                    // Refresh data without page reload
                    await loadApplicationsList()
                    await loadDashboardStats()
                    
                    console.log('Data refreshed after delete')
                } else {
                    console.error('Delete failed:', result.error)
                    alert('Error: ' + result.error)
                }
            } catch (error) {
                console.error('Error deleting application:', error)
                alert('Terjadi kesalahan saat menghapus aplikasi: ' + error.message)
            }
        }
        
        // Logout function
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                sessionStorage.removeItem('adminLogin')
                localStorage.removeItem('adminLogin')
                window.location.href = 'login.html'
            }
        }
        
        // ===================================
        // ANALYTICS FUNCTIONS
        // ===================================
        
        // Load analytics data
        async function loadAnalytics() {
            try {
                // For development: use localStorage data
                const localData = JSON.parse(localStorage.getItem('analytics_data') || '[]')
                
                if (localData.length > 0) {
                    // Store data globally for filtering
                    currentAnalyticsData = localData
                    
                    // Populate filter options
                    populateFilterOptions(localData)
                    
                    // Display data
                    displayAnalyticsStats(localData)
                    displayAnalyticsTable(localData)
                    displayTopPages(localData)
                    displayRecentVisitors(localData)
                } else {
                    // Try to load from Supabase if available
                    if (window.supabase) {
                        await loadAnalyticsFromDatabase()
                    } else {
                        showNoAnalyticsData()
                    }
                }
            } catch (error) {
                console.error('Error loading analytics:', error)
                showNoAnalyticsData()
            }
        }
        
        // Load analytics from Supabase database
        async function loadAnalyticsFromDatabase() {
            try {
                const { data, error } = await window.supabase
                    .from('visitor_logs')
                    .select('*')
                    .order('visit_timestamp', { ascending: false })
                    .limit(1000)
                
                if (error) throw error
                
                // Store data globally for filtering
                currentAnalyticsData = data
                
                // Populate filter options
                populateFilterOptions(data)
                
                // Display data
                displayAnalyticsStats(data)
                displayAnalyticsTable(data)
                displayTopPages(data)
                displayRecentVisitors(data)
            } catch (error) {
                console.error('Error loading from database:', error)
                showNoAnalyticsData()
            }
        }
        
        // Display analytics statistics
        function displayAnalyticsStats(data) {
            const today = new Date().toDateString()
            const todayData = data.filter(item => {
                const itemDate = new Date(item.visit_timestamp || item.timestamp)
                return itemDate.toDateString() === today
            })
            
            const uniqueIPs = new Set(data.map(item => item.ip_address || 'unknown')).size
            const uniqueSessionsToday = new Set(todayData.map(item => item.session_id)).size
            
            document.getElementById('totalVisitors').textContent = data.length
            document.getElementById('todayVisitors').textContent = todayData.length
            document.getElementById('totalPageViews').textContent = data.length
            document.getElementById('uniqueVisitors').textContent = uniqueIPs
            
            // Create charts
            createVisitorChart(data)
            createDeviceChart(data)
        }
        
        // Display analytics table
        function displayAnalyticsTable(data) {
            const tbody = document.getElementById('analyticsTableBody')
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No analytics data available</td></tr>'
                return
            }
            
            const rows = data.slice(0, 50).map(item => {
                const timestamp = new Date(item.visit_timestamp || item.timestamp)
                const formattedTime = timestamp.toLocaleString('id-ID')
                
                return `
                    <tr>
                        <td>${formattedTime}</td>
                        <td>${item.page_url || item.page || 'Unknown'}</td>
                        <td>${item.ip_address || 'Unknown'}</td>
                        <td>${item.device_type || 'Unknown'}</td>
                        <td>${item.browser || 'Unknown'}</td>
                        <td>${item.referrer || 'Direct'}</td>
                    </tr>
                `
            }).join('')
            
            tbody.innerHTML = rows
        }
        
        // Display top pages
        function displayTopPages(data) {
            const pageCount = {}
            data.forEach(item => {
                const page = item.page_url || item.page || 'Unknown'
                pageCount[page] = (pageCount[page] || 0) + 1
            })
            
            const sortedPages = Object.entries(pageCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
            
            const html = sortedPages.map(([page, count]) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-truncate" style="max-width: 200px;" title="${page}">${page}</span>
                    <span class="badge badge-primary">${count}</span>
                </div>
            `).join('')
            
            document.getElementById('topPages').innerHTML = html || '<p class="text-muted">No data available</p>'
        }
        
        // Display recent visitors
        function displayRecentVisitors(data) {
            const recent = data.slice(0, 10)
            
            const html = recent.map(item => {
                const timestamp = new Date(item.visit_timestamp || item.timestamp)
                const timeAgo = getTimeAgo(timestamp)
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="text-muted">${item.ip_address || 'Unknown IP'}</small><br>
                            <small>${item.page_url || item.page || 'Unknown page'}</small>
                        </div>
                        <small class="text-muted">${timeAgo}</small>
                    </div>
                `
            }).join('')
            
            document.getElementById('recentVisitors').innerHTML = html || '<p class="text-muted">No recent visitors</p>'
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date()
            const diffMs = now - date
            const diffMins = Math.floor(diffMs / 60000)
            const diffHours = Math.floor(diffMins / 60)
            const diffDays = Math.floor(diffHours / 24)
            
            if (diffMins < 1) return 'Just now'
            if (diffMins < 60) return `${diffMins}m ago`
            if (diffHours < 24) return `${diffHours}h ago`
            return `${diffDays}d ago`
        }
        
        // Show no analytics data message
        function showNoAnalyticsData() {
            document.getElementById('totalVisitors').textContent = '0'
            document.getElementById('todayVisitors').textContent = '0'
            document.getElementById('totalPageViews').textContent = '0'
            document.getElementById('uniqueVisitors').textContent = '0'
            
            document.getElementById('analyticsTableBody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-muted">No analytics data available. Make sure to visit your website to generate data.</td></tr>'
            
            document.getElementById('topPages').innerHTML = '<p class="text-muted">No data available</p>'
            document.getElementById('recentVisitors').innerHTML = '<p class="text-muted">No recent visitors</p>'
        }
        
        // Chart instances
        let visitorChart = null
        let deviceChart = null
        
        // Create visitor trends chart
        function createVisitorChart(data) {
            const ctx = document.getElementById('visitorChart').getContext('2d')
            
            // Destroy existing chart if it exists
            if (visitorChart) {
                visitorChart.destroy()
            }
            
            // Process data for last 7 days
            const last7Days = []
            const visitorCounts = []
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date()
                date.setDate(date.getDate() - i)
                const dateStr = date.toISOString().split('T')[0]
                
                last7Days.push(date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' }))
                
                // Count visitors for this date
                const dayVisitors = data.filter(item => {
                    const itemDate = new Date(item.visit_timestamp || item.timestamp)
                    return itemDate.toISOString().split('T')[0] === dateStr
                }).length
                
                visitorCounts.push(dayVisitors)
            }
            
            visitorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Visitors',
                        data: visitorCounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            })
        }
        
        // Create device types chart
        function createDeviceChart(data) {
            const ctx = document.getElementById('deviceChart').getContext('2d')
            
            // Destroy existing chart if it exists
            if (deviceChart) {
                deviceChart.destroy()
            }
            
            // Count device types
            const deviceCounts = {}
            data.forEach(item => {
                const device = item.device_type || 'Unknown'
                deviceCounts[device] = (deviceCounts[device] || 0) + 1
            })
            
            const labels = Object.keys(deviceCounts)
            const counts = Object.values(deviceCounts)
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe']
            
            deviceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            })
        }
        
        // Global variable to store current analytics data
        let currentAnalyticsData = []
        
        // Apply filters to analytics data
        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter').value
            const pageFilter = document.getElementById('pageFilter').value
            const deviceFilter = document.getElementById('deviceFilter').value
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase()
            
            let filteredData = [...currentAnalyticsData]
            
            // Date filter
            if (dateFilter !== 'all') {
                const now = new Date()
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
                
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.visit_timestamp || item.timestamp)
                    
                    switch (dateFilter) {
                        case 'today':
                            return itemDate >= today
                        case 'yesterday':
                            const yesterday = new Date(today)
                            yesterday.setDate(yesterday.getDate() - 1)
                            return itemDate >= yesterday && itemDate < today
                        case 'week':
                            const weekAgo = new Date(today)
                            weekAgo.setDate(weekAgo.getDate() - 7)
                            return itemDate >= weekAgo
                        case 'month':
                            const monthAgo = new Date(today)
                            monthAgo.setDate(monthAgo.getDate() - 30)
                            return itemDate >= monthAgo
                        default:
                            return true
                    }
                })
            }
            
            // Page filter
            if (pageFilter !== 'all') {
                filteredData = filteredData.filter(item => 
                    (item.page_url || item.page || '').includes(pageFilter)
                )
            }
            
            // Device filter
            if (deviceFilter !== 'all') {
                filteredData = filteredData.filter(item => 
                    (item.device_type || '').toLowerCase() === deviceFilter.toLowerCase()
                )
            }
            
            // Search filter
            if (searchFilter) {
                filteredData = filteredData.filter(item => {
                    const searchableText = [
                        item.ip_address || '',
                        item.browser || '',
                        item.os || '',
                        item.page_url || item.page || '',
                        item.referrer || ''
                    ].join(' ').toLowerCase()
                    
                    return searchableText.includes(searchFilter)
                })
            }
            
            // Update display with filtered data
            displayAnalyticsStats(filteredData)
            displayAnalyticsTable(filteredData)
        }
        
        // Populate filter options
        function populateFilterOptions(data) {
            // Populate page filter
            const pageFilter = document.getElementById('pageFilter')
            const pages = [...new Set(data.map(item => item.page_url || item.page || ''))]
                .filter(page => page)
                .sort()
            
            pageFilter.innerHTML = '<option value="all">All Pages</option>'
            pages.forEach(page => {
                const option = document.createElement('option')
                option.value = page
                option.textContent = page.replace(/.*\//, '') || page
                pageFilter.appendChild(option)
            })
            
            // Populate device filter
            const deviceFilter = document.getElementById('deviceFilter')
            const devices = [...new Set(data.map(item => item.device_type || ''))]
                .filter(device => device)
                .sort()
            
            deviceFilter.innerHTML = '<option value="all">All Devices</option>'
            devices.forEach(device => {
                const option = document.createElement('option')
                option.value = device
                option.textContent = device
                deviceFilter.appendChild(option)
            })
        }
        
        // Refresh analytics
        function refreshAnalytics() {
            loadAnalytics()
        }
        
        // Export analytics data (filtered)
        function exportAnalytics() {
            try {
                // Get currently filtered data
                const dateFilter = document.getElementById('dateFilter').value
                const pageFilter = document.getElementById('pageFilter').value
                const deviceFilter = document.getElementById('deviceFilter').value
                const searchFilter = document.getElementById('searchFilter').value
                
                let dataToExport = [...currentAnalyticsData]
                
                // Apply same filters as display
                if (dateFilter !== 'all' || pageFilter !== 'all' || deviceFilter !== 'all' || searchFilter) {
                    // Use the same filtering logic as applyFilters()
                    applyFilters() // This will update the display
                    // For export, we'll use the current filtered data
                    dataToExport = currentAnalyticsData // This should be updated to get filtered data
                }
                
                if (dataToExport.length === 0) {
                    alert('No analytics data to export')
                    return
                }
                
                const csvContent = convertToCSV(dataToExport)
                const filename = `analytics_data_${new Date().toISOString().split('T')[0]}.csv`
                downloadCSV(csvContent, filename)
            } catch (error) {
                console.error('Error exporting analytics:', error)
                alert('Error exporting data')
            }
        }
        
        // Convert data to CSV
        function convertToCSV(data) {
            const headers = ['Timestamp', 'Page URL', 'IP Address', 'Device Type', 'Browser', 'OS', 'Referrer']
            const csvRows = [headers.join(',')]
            
            data.forEach(item => {
                const row = [
                    item.visit_timestamp || item.timestamp || '',
                    item.page_url || item.page || '',
                    item.ip_address || '',
                    item.device_type || '',
                    item.browser || '',
                    item.os || '',
                    item.referrer || ''
                ].map(field => `"${field}"`)
                
                csvRows.push(row.join(','))
            })
            
            return csvRows.join('\n')
        }
        
        // Download CSV file
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
            const link = document.createElement('a')
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob)
                link.setAttribute('href', url)
                link.setAttribute('download', filename)
                link.style.visibility = 'hidden'
                document.body.appendChild(link)
                link.click()
                document.body.removeChild(link)
            }
        }
        
        // Load analytics when analytics tab is shown
        $('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
            if (e.target.getAttribute('href') === '#analytics') {
                loadAnalytics()
            }
        })
    </script>
</body>
</html>